{% layout 'theme' %}

{{ 'template-collection.css' | asset_url | stylesheet_tag }}
{{ 'component-card.css' | asset_url | stylesheet_tag }}

<div class="page-width" style="max-width:1100px;margin:0 auto;padding:28px 16px;">
  <h1 class="title title--primary" style="margin:0 0 14px;">IRIS Archive</h1>

  <div class="iris-archive-filters" style="display:flex;flex-wrap:wrap;gap:14px;margin:0 0 18px;">
    <a class="iris-filter is-active" data-rarity="all" href="#">All</a>
    <a class="iris-filter" data-rarity="Common" href="#">Common</a>
    <a class="iris-filter" data-rarity="Uncommon" href="#">Uncommon</a>
    <a class="iris-filter" data-rarity="Rare" href="#">Rare</a>
    <a class="iris-filter" data-rarity="Ultra Rare" href="#">Ultra Rare</a>
    <a class="iris-filter" data-rarity="Artist Edition" href="#">Artist Edition</a>
  </div>

  <style>
    .iris-archive-filters .iris-filter {
      font-size: 14px;
      font-weight: 600;
      color: #111;
      text-decoration: none;
    }
    .iris-archive-filters .iris-filter.is-active {
      text-decoration: underline;
      text-decoration-thickness: 2px;
      text-underline-offset: 4px;
    }
  </style>

  <div id="iris-archive" class="collection">
    <div class="loading-overlay gradient" id="iris-archive-loading"></div>
    <ul
      id="iris-archive-grid"
      class="grid product-grid grid--2-col-tablet-down grid--4-col-desktop"
    ></ul>
  </div>

  <div style="text-align:center;margin:24px 0;">
    <button id="iris-archive-load" class="button" type="button">Load more</button>
  </div>

  <p id="iris-archive-empty" hidden>No activated IRIS yet.</p>
  <p id="iris-archive-error" hidden style="color:#b00020;">Could not load IRIS right now.</p>
</div>

<script>
  (function () {
    var grid = document.getElementById('iris-archive-grid');
    var loadBtn = document.getElementById('iris-archive-load');
    var empty = document.getElementById('iris-archive-empty');
    var error = document.getElementById('iris-archive-error');
    var loading = document.getElementById('iris-archive-loading');
    var filterButtons = document.querySelectorAll('.iris-filter');
    var cursor = null;
    var done = false;
    var rarity = 'all';
    var pageSize = 20;

    if (loadBtn) loadBtn.hidden = true;

    function labelFromId(id) {
      if (!id) return '';
      var clean = id.replace(/^IRIS-?/i, '').trim();
      return 'IRIS # ' + clean;
    }

    function renderItems(items) {
      var html = items.map(function (item) {
        var full = item.image_url || '';
        var img = full
          ? '<img src="' + full + '" alt="' + item.iris_id + '" loading="lazy">'
          : '<div style="background:#e5e7eb;width:100%;height:100%;"></div>';

        var href = '/pages/iris-passport?iris_id=' + encodeURIComponent(item.iris_id);

        return (
          '<li class="grid__item">' +
            '<div class="card-wrapper product-card-wrapper underline-links-hover">' +
              '<div class="card card--standard card--media">' +
                '<div class="card__inner ratio" style="--ratio-percent: 100%;">' +
                  '<a class="full-unstyled-link" href="' + href + '">' +
                    '<div class="card__media">' +
                      '<div class="media media--transparent media--hover-effect">' +
                        img +
                      '</div>' +
                    '</div>' +
                  '</a>' +
                '</div>' +
                '<div class="card__content">' +
                  '<div class="card__information">' +
                    '<h3 class="card__heading h5" style="text-align:center;font-weight:600;">' + labelFromId(item.iris_id) + '</h3>' +
                  '</div>' +
                '</div>' +
              '</div>' +
            '</div>' +
          '</li>'
        );
      }).join('');

      grid.insertAdjacentHTML('beforeend', html);
    }

    function loadNext() {
      if (done) return;
      if (loading) loading.hidden = false;
      var url = '/apps/iris/seen-archive?limit=' + pageSize;
      if (cursor) url += '&cursor=' + encodeURIComponent(cursor);
      if (rarity && rarity !== 'all') url += '&rarity=' + encodeURIComponent(rarity);
      fetch(url, { headers: { 'Accept': 'application/json' } })
        .then(function (res) {
          if (!res.ok) throw new Error('bad_status');
          return res.json();
        })
        .then(function (data) {
          var items = (data && data.items) ? data.items : [];
          if (!items.length && !cursor) {
            empty.hidden = false;
            done = true;
            loadBtn.hidden = true;
            return;
          }
          renderItems(items);
          cursor = data.nextCursor;
          if (!cursor || items.length < pageSize) {
            done = true;
            loadBtn.hidden = true;
          } else {
            loadBtn.hidden = false;
          }
        })
        .catch(function () {
          error.hidden = false;
        })
        .finally(function () {
          if (loading) loading.hidden = true;
        });
    }

    function resetAndLoad(newRarity) {
      rarity = newRarity || 'all';
      cursor = null;
      done = false;
      grid.innerHTML = '';
      empty.hidden = true;
      error.hidden = true;
      loadBtn.hidden = false;
      loadNext();
    }

    filterButtons.forEach(function (btn) {
      btn.addEventListener('click', function (e) {
        e.preventDefault();
        filterButtons.forEach(function (b) { b.classList.remove('is-active'); });
        btn.classList.add('is-active');
        resetAndLoad(btn.getAttribute('data-rarity') || 'all');
      });
    });

    loadBtn.addEventListener('click', loadNext);
    loadNext();
  })();
</script>
