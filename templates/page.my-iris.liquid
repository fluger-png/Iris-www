{% layout 'theme' %}

{{ 'template-collection.css' | asset_url | stylesheet_tag }}
{{ 'component-card.css' | asset_url | stylesheet_tag }}

<div class="page-width" style="max-width:1100px;margin:0 auto;padding:28px 16px;">
  <h1 class="title title--primary" style="margin:0 0 14px;">My IRIS</h1>

  {% if customer == nil %}
    <p style="margin:0 0 12px;">Please sign in to view your IRIS.</p>
    <a href="/account"
       style="display:inline-block;padding:10px 14px;border:1px solid #111;border-radius:12px;text-decoration:none;">
      Sign in
    </a>
  {% else %}
    <style>
      .iris-collection { margin-top: 18px; }
      .iris-placeholder { background: #e5e7eb; width: 100%; height: 100%; }
      .iris-card-label { text-align: center; font-weight: 600; }
    </style>

    <div id="iris-app" data-email="{{ customer.email | escape }}">
      <p id="iris-loading" style="margin:0 0 12px;">Loading your IRISâ€¦</p>

      <div id="iris-empty" hidden>
        <p style="margin:0 0 12px;">No IRIS activated yet</p>
      </div>

      <div class="collection iris-collection">
        <ul
          id="iris-grid"
          class="grid product-grid grid--2-col-tablet-down grid--4-col-desktop"
        ></ul>
      </div>

      <p id="iris-error" hidden style="margin:14px 0 0;font-size:14px;color:#b00020;">
        Could not load IRIS right now. Please try again.
      </p>

      <noscript>
        <p style="margin:12px 0;">Please enable JavaScript to view your IRIS.</p>
      </noscript>
    </div>

    <script>
      (function () {
        var app = document.getElementById('iris-app');
        if (!app) return;

        var email = app.getAttribute('data-email');
        var loading = document.getElementById('iris-loading');
        var empty = document.getElementById('iris-empty');
        var grid = document.getElementById('iris-grid');
        var error = document.getElementById('iris-error');

        function labelFromId(id) {
          if (!id) return '';
          var clean = id.replace(/^IRIS-?/i, '').trim();
          return 'IRIS # ' + clean;
        }

        fetch('/apps/iris/my-iris?email=' + encodeURIComponent(email), {
          headers: { 'Accept': 'application/json' }
        })
          .then(function (res) {
            if (!res.ok) throw new Error('bad_status');
            return res.json();
          })
          .then(function (data) {
            if (loading) loading.hidden = true;

            var items = (data && data.items) ? data.items : [];
            if (!items.length) {
              empty.hidden = false;
              return;
            }

            var html = items.map(function (item) {
              var full = item.image_url || '';
              var img = full
                ? '<img src="' + full + '" alt="' + item.iris_id + '" loading="lazy">'
                : '<div class="iris-placeholder"></div>';
              var href = item.passport_url || ('/pages/iris-passport?iris_id=' + encodeURIComponent(item.iris_id));
              return (
                '<li class="grid__item">' +
                  '<div class="card-wrapper product-card-wrapper underline-links-hover">' +
                    '<div class="card card--standard card--media">' +
                      '<a class="full-unstyled-link" href="' + href + '">' +
                        '<div class="card__inner ratio" style="--ratio-percent: 100%;">' +
                          '<div class="card__media">' +
                            '<div class="media media--transparent media--hover-effect">' +
                              img +
                            '</div>' +
                          '</div>' +
                        '</div>' +
                      '</a>' +
                      '<div class="card__content">' +
                        '<div class="card__information">' +
                          '<h3 class="card__heading h5 iris-card-label">' +
                            '<a class="full-unstyled-link" href="' + href + '">' + labelFromId(item.iris_id) + '</a>' +
                          '</h3>' +
                        '</div>' +
                      '</div>' +
                    '</div>' +
                  '</div>' +
                '</li>'
              );
            }).join('');

            grid.innerHTML = html;
          })
          .catch(function () {
            if (loading) loading.hidden = true;
            error.hidden = false;
          });
      })();
    </script>
  {% endif %}
</div>
