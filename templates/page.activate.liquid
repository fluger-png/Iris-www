{% layout 'theme' %}

<div class="page-width" style="max-width:700px;margin:0 auto;padding:40px 16px;text-align:center;">

  <h1>Activate your IRIS</h1>

  <p>
    You are about to activate your IRIS artwork.<br>
    Activation confirms you scanned the NFC tag.
  </p>

  <div style="margin:20px auto 20px;max-width:400px;">
    {% if settings.logo %}
      <img id="irisPreview" src="{{ settings.logo | image_url: width: 800 }}" alt="IRIS" style="width:400px;height:400px;object-fit:contain;background:#f3f4f6;border:1px solid #eee;border-radius:0px;">
    {% else %}
      <img id="irisPreview" src="https://cdn.shopify.com/s/files/1/0710/5239/4589/files/P1.png?v=1769584244" alt="IRIS" style="width:400px;height:400px;object-fit:contain;background:#f3f4f6;border:1px solid #eee;border-radius:0px;">
    {% endif %}
  </div>

  <div style="margin:10px 0 20px;padding:0;border:0;border-radius:0px;">
    <div id="irisId" style="font-size:22px;font-weight:600;">—</div>
  </div>

  <form id="activateForm" style="max-width:420px;margin:0 auto;display:flex;flex-direction:column;align-items:center;gap:20px;">
    <div style="text-align:center;">
      <label for="pinInput" style="font-size:12px;opacity:.7;display:block;margin-bottom:10px;">Activation PIN</label>
      <input id="pinInput" type="password" inputmode="numeric" maxlength="6" placeholder="******"
             style="width:160px;height:60px;font-size:20px;text-align:center;color:#333;border:1px solid #111;border-radius:0px;">
    </div>

    {% if customer %}
      <input id="emailInput" type="hidden" value="{{ customer.email | escape }}">
      <p style="font-size:12px;opacity:.6;margin:0 0 12px;text-align:left;">
        Activating as {{ customer.email }}
      </p>
    {% else %}
      <div style="text-align:center;">
        <label for="emailInput" style="font-size:12px;opacity:.7;display:block;margin-bottom:10px;">Email</label>
        <input id="emailInput" type="email"
               style="width:320px;height:60px;font-size:20px;text-align:center;color:#333;border:1px solid #111;border-radius:0px;">
      </div>
    {% endif %}

    <button id="activateBtn" type="submit" class="button button--primary" style="height:60px;display:inline-flex;align-items:center;justify-content:center;">
      Activate my IRIS
    </button>
  </form>

  <p id="activateMsg" style="margin-top:16px;font-size:14px;"></p>

  <p style="margin-top:20px;font-size:14px;opacity:.8;">
    After activation, your artwork may appear in the IRIS Seen Collection (no personal data).
  </p>

</div>

<script>
  var isLoggedIn = {{ customer != nil | json }};
  const params = new URLSearchParams(window.location.search);
  let iris = params.get("iris");
  let tokenParam = params.get("token");
  let token = "";

  function normalize(v){
    if(!v) return "";
    if(/^IRIS-\d{4}$/i.test(v)) return v.toUpperCase();
    var match = v.match(/^(IRIS-\d{4})-(.+)$/i);
    if (match) {
      token = match[2];
      return match[1].toUpperCase();
    }
    const d=(v.match(/\d+/)||[""])[0];
    return "IRIS-"+d.padStart(4,"0").slice(-4);
  }

  const irisId = normalize(iris);

  document.getElementById("irisId").textContent = irisId || "Unknown";

  const form = document.getElementById("activateForm");
  const pinInput = document.getElementById("pinInput");
  const emailInput = document.getElementById("emailInput");
  const msg = document.getElementById("activateMsg");

  async function hydrateFromToken(tok) {
    try {
      const res = await fetch("/apps/iris/activation-info?token=" + encodeURIComponent(tok), { headers: { "Accept": "application/json" } });
      if (!res.ok) return;
      const data = await res.json();
      if (data && data.iris_id) {
        document.getElementById("irisId").textContent = data.iris_id;
      }
      if (data && data.image_url) {
        var img = document.getElementById("irisPreview");
        if (img) img.src = data.image_url;
      }
    } catch (e) {}
  }

  if (!irisId && tokenParam) {
    token = tokenParam;
    hydrateFromToken(tokenParam);
  }

  if (!irisId && !tokenParam) {
    msg.textContent = "Missing IRIS ID in the link.";
    form.querySelector("button").disabled = true;
  }

  pinInput.addEventListener("input", function () {
    pinInput.style.color = pinInput.value ? "#000" : "#333";
  });

  form.addEventListener("submit", async function (e) {
    e.preventDefault();
    msg.textContent = "";

    const pin = pinInput.value.trim();
    const email = emailInput.value.trim().toLowerCase();
    pinInput.style.color = pin ? "#000" : "#333";
    if (!pin || pin.length < 6) {
      msg.textContent = "Please enter your 6-digit PIN.";
      return;
    }
    if (!email) {
      msg.textContent = "Please enter your email.";
      return;
    }

    try {
      const res = await fetch("/apps/iris/activate-verify", {
        method: "POST",
        headers: { "Content-Type": "application/json", "Accept": "application/json" },
        body: JSON.stringify({ iris_id: token ? (irisId + "-" + token) : irisId, pin, email, token: token || tokenParam })
      });
      const data = await res.json();
      if (!res.ok) {
        if (data.error === "invalid_pin") {
          msg.textContent = "Invalid PIN. Please try again.";
        } else if (data.error === "invalid_activation_link") {
          msg.textContent = "Invalid activation link. Please contact support.";
        } else if (data.error === "too_many_attempts") {
          msg.textContent = "Too many attempts. Please wait and try again.";
        } else if (data.error === "already_activated") {
          msg.textContent = "This IRIS is already activated.";
        } else if (data.error === "pin_not_set") {
          msg.textContent = "PIN not available yet. Please contact support.";
        } else {
          msg.textContent = "Activation failed. Please try again.";
        }
        return;
      }
      msg.textContent = "Activated. Redirecting…";
      setTimeout(function () {
        if (isLoggedIn) {
          window.location.assign("/pages/my-iris");
        } else {
          window.location.assign("/account/login?return_url=/pages/my-iris");
        }
      }, 800);
    } catch (err) {
      msg.textContent = "Activation failed. Please try again.";
    }
  });
</script>
