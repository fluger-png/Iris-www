{{ 'component-card.css' | asset_url | stylesheet_tag }}
{{ 'template-collection.css' | asset_url | stylesheet_tag }}

{%- style -%}
  .section-{{ section.id }}-padding {
    padding-top: {{ section.settings.padding_top | times: 0.75 | round: 0 }}px;
    padding-bottom: {{ section.settings.padding_bottom | times: 0.75 | round: 0 }}px;
  }

  @media screen and (min-width: 750px) {
    .section-{{ section.id }}-padding {
      padding-top: {{ section.settings.padding_top }}px;
      padding-bottom: {{ section.settings.padding_bottom }}px;
    }
  }
{%- endstyle -%}

<div id="RevealedArchiveSection-{{ section.id }}" class="color-{{ section.settings.color_scheme }} gradient">
  <div class="collection section-{{ section.id }}-padding{% if section.settings.full_width %} collection--full-width{% endif %}">
    <div class="collection__title title-wrapper title-wrapper--no-top-margin page-width">
      <h2 class="title inline-richtext {{ section.settings.heading_size }}">
        {{ section.settings.title }}
      </h2>
      <div class="collection__description {{ section.settings.description_style }} rte" {% if section.settings.description == blank %}style="display:none;"{% endif %}>
        {{ section.settings.description }}
      </div>
    </div>

    <div class="page-width">
      <ul
        id="RevealedArchiveGrid-{{ section.id }}"
        class="grid product-grid contains-card contains-card--product grid--{{ section.settings.columns_desktop }}-col-desktop grid--{{ section.settings.columns_mobile }}-col-tablet-down"
        role="list"
      ></ul>
    </div>

    <div class="center collection__view-all" {% if section.settings.show_view_more == false %}style="display:none;"{% endif %}>
      <a
        href="{{ section.settings.view_more_link | default: '/pages/iris-archive' }}"
        class="{% if section.settings.view_more_style == 'link' %}link underlined-link{% elsif section.settings.view_more_style == 'solid' %}button{% else %}button button--secondary{% endif %}"
      >
        {{ section.settings.view_more_label }}
      </a>
    </div>
  </div>
</div>

<script>
  (function () {
    var sectionEl = document.getElementById('RevealedArchiveSection-{{ section.id }}');
    var grid = document.getElementById('RevealedArchiveGrid-{{ section.id }}');

    if (!sectionEl || !grid) return;

    function labelFromId(id) {
      if (!id) return '';
      var clean = id.replace(/^IRIS-?/i, '').trim();
      return 'IRIS # ' + clean;
    }

    function renderItems(items) {
      var html = items.map(function (item) {
        var full = item.image_url || '';
        var img = full
          ? '<img src="' + full + '" alt="' + item.iris_id + '" loading="lazy">'
          : '<div style="background:#e5e7eb;width:100%;height:100%;"></div>';
        var href = '/pages/iris-passport?iris_id=' + encodeURIComponent(item.iris_id);

        return (
          '<li class="grid__item">' +
            '<div class="card-wrapper product-card-wrapper underline-links-hover">' +
              '<div class="card card--standard card--media">' +
                '<div class="card__inner ratio" style="--ratio-percent: 100%;">' +
                  '<a class="full-unstyled-link" href="' + href + '">' +
                    '<div class="card__media">' +
                      '<div class="media media--transparent media--hover-effect">' +
                        img +
                      '</div>' +
                    '</div>' +
                  '</a>' +
                '</div>' +
                '<div class="card__content">' +
                  '<div class="card__information">' +
                    '<h3 class="card__heading h5" style="text-align:center;font-weight:600;">' + labelFromId(item.iris_id) + '</h3>' +
                  '</div>' +
                '</div>' +
              '</div>' +
            '</div>' +
          '</li>'
        );
      }).join('');

      grid.insertAdjacentHTML('beforeend', html);
    }

    fetch('/apps/iris/seen-archive?limit={{ section.settings.items_to_show }}', { headers: { 'Accept': 'application/json' } })
      .then(function (res) {
        if (!res.ok) throw new Error('bad_status');
        return res.json();
      })
      .then(function (data) {
        var items = (data && data.items) ? data.items : [];
        if (!items.length) {
          sectionEl.style.display = 'none';
          return;
        }
        renderItems(items);
      })
      .catch(function () {
        sectionEl.style.display = 'none';
      });
  })();
</script>

{% schema %}
{
  "name": "Revealed Archive",
  "tag": "section",
  "class": "section",
  "disabled_on": {
    "groups": ["header", "footer"]
  },
  "settings": [
    {
      "type": "inline_richtext",
      "id": "title",
      "label": "Title",
      "default": "Revealed Archive"
    },
    {
      "type": "richtext",
      "id": "description",
      "label": "Description"
    },
    {
      "type": "select",
      "id": "heading_size",
      "label": "Heading size",
      "options": [
        { "value": "h2", "label": "Small" },
        { "value": "h1", "label": "Medium" },
        { "value": "h0", "label": "Large" }
      ],
      "default": "h2"
    },
    {
      "type": "select",
      "id": "description_style",
      "label": "Description style",
      "options": [
        { "value": "body", "label": "Body" },
        { "value": "subtitle", "label": "Subtitle" }
      ],
      "default": "body"
    },
    {
      "type": "range",
      "id": "items_to_show",
      "min": 2,
      "max": 12,
      "step": 1,
      "default": 4,
      "label": "IRIS to show"
    },
    {
      "type": "range",
      "id": "columns_desktop",
      "min": 2,
      "max": 6,
      "step": 1,
      "default": 4,
      "label": "Columns desktop"
    },
    {
      "type": "select",
      "id": "columns_mobile",
      "label": "Columns mobile",
      "options": [
        { "value": "1", "label": "1" },
        { "value": "2", "label": "2" }
      ],
      "default": "2"
    },
    {
      "type": "checkbox",
      "id": "show_view_more",
      "label": "Show view more link",
      "default": true
    },
    {
      "type": "text",
      "id": "view_more_label",
      "label": "View more label",
      "default": "View more"
    },
    {
      "type": "url",
      "id": "view_more_link",
      "label": "View more link"
    },
    {
      "type": "select",
      "id": "view_more_style",
      "label": "View more style",
      "options": [
        { "value": "link", "label": "Link" },
        { "value": "solid", "label": "Solid" },
        { "value": "outline", "label": "Outline" }
      ],
      "default": "link"
    },
    {
      "type": "checkbox",
      "id": "full_width",
      "label": "Full width",
      "default": false
    },
    {
      "type": "color_scheme",
      "id": "color_scheme",
      "label": "Color scheme",
      "default": "scheme-1"
    },
    {
      "type": "header",
      "content": "Padding"
    },
    {
      "type": "range",
      "id": "padding_top",
      "min": 0,
      "max": 100,
      "step": 4,
      "unit": "px",
      "label": "Padding top",
      "default": 36
    },
    {
      "type": "range",
      "id": "padding_bottom",
      "min": 0,
      "max": 100,
      "step": 4,
      "unit": "px",
      "label": "Padding bottom",
      "default": 36
    }
  ],
  "presets": [
    {
      "name": "Revealed Archive"
    }
  ]
}
{% endschema %}
